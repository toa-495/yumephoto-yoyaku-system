<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>不可枠設定（社内）</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --text:#222; --muted:#666; --line:#e7e7ef; --accent:#2b6cff; --bad:#e5484d; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    h1{ font-size:18px; margin:0 0 6px; }
    .small{ font-size:12px; color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ appearance:none; border:0; background:var(--accent); color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn2{ background:#111827; }
    .btnDanger{ background:var(--bad); }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .grid{ display:grid; grid-template-columns: 240px 1fr; gap:12px; margin-top:12px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .list{ max-height:520px; overflow:auto; border:1px solid var(--line); border-radius:12px; background:#fff; }
    .day{ padding:10px 12px; border-bottom:1px solid var(--line); cursor:pointer; }
    .day.active{ background:#eef4ff; }
    .slots{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px; }
    @media (max-width:560px){ .slots{ grid-template-columns:1fr; } }
    .slot{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; cursor:pointer;
      user-select:none;
    }
    .slot.blocked{ border-color: #ffb4b6; background:#fff1f1; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .hint{ background:#0b1020; color:#e8f0ff; padding:10px 12px; border-radius:12px; }
    .msg{ margin-top:8px; color:#b91c1c; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>不可枠設定（社内）</h1>
      <div class="small">token 付きURLで開いて、不可枠をクリックでON/OFF → 保存。</div>

      <div style="height:10px"></div>

      <div class="row">
        <span class="pill small">token: <span id="tokenView" class="mono"></span></span>
        <span class="pill small">期間: <span id="rangeView" class="mono"></span></span>

        <button class="btn btn2" id="reloadBtn">再読み込み</button>
        <button class="btn" id="saveBtn">保存</button>
        <button class="btn btnDanger" id="clearDayBtn">この日の不可枠を全解除</button>
        <button class="btn" id="blockDayBtn">この日を全て不可にする</button>
      </div>

      <div style="height:10px"></div>
      <div class="hint small">
        使い方：枠をクリックで「不可/可」を切り替え → 保存。<br/>
        「この日を全て不可」は、その日の全スロットをまとめて不可にします。
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:8px;">日付</div>
        <div id="days" class="list"></div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:8px;">時間枠</div>
        <div id="slots" class="slots"></div>
      </div>
    </div>
  </div>

<script>
  // ★あなたのGAS /exec に合わせる
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyJAPDsCu9QtgbZbg-4LrNqh_wY2GVROVecUT9ksO0RovJINC5As5ywcke_GJ50WmBL/exec";

  function qs(name){
    return new URLSearchParams(location.search).get(name);
  }
  function el(id){ return document.getElementById(id); }

  let token = "";
  let slots = [];     // [{start,end,startLocal,endLocal}]
  let blocks = [];    // [{startIso,endIso,reason?}]
  let selectedDayKey = "";
  let dirty = false;

  function post(action, payload){
    return fetch(GAS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action, ...payload })
    })
    .then(async r=>{
      const t = await r.text();
      let j;
      try{ j = JSON.parse(t); }catch(e){
        throw new Error("JSONではない応答: " + t.slice(0,120));
      }
      if(!j.ok) throw new Error(j.error || "Unknown error");
      return j;
    });
  }

  function slotKey(s){ return s.start + "__" + s.end; }
  function blockKey(b){ return b.startIso + "__" + b.endIso; }

  function buildDayMap(){
    const map = new Map();
    for(const s of slots){
      const dayKey = (s.startLocal && s.startLocal.slice(0,10)) || new Date(s.start).toISOString().slice(0,10);
      if(!map.has(dayKey)) map.set(dayKey, []);
      map.get(dayKey).push(s);
    }
    for(const [k, arr] of map.entries()){
      arr.sort((a,b)=> a.start.localeCompare(b.start));
    }
    return map;
  }

  function renderDays(dayMap){
    const box = el("days");
    box.innerHTML = "";
    const keys = Array.from(dayMap.keys()).sort();
    if(!selectedDayKey && keys.length) selectedDayKey = keys[0];

    keys.forEach(k=>{
      const div = document.createElement("div");
      div.className = "day" + (k===selectedDayKey ? " active":"");
      div.textContent = k;
      div.onclick = ()=>{
        selectedDayKey = k;
        renderDays(dayMap);
        renderSlots(dayMap);
      };
      box.appendChild(div);
    });
  }

  function renderSlots(dayMap){
    const box = el("slots");
    box.innerHTML = "";
    const daySlots = dayMap.get(selectedDayKey) || [];
    const blockedSet = new Set(blocks.map(b=>blockKey(b)));

    daySlots.forEach(s=>{
      const div = document.createElement("div");
      const isBlocked = blockedSet.has(slotKey(s).replace("__", "__")); // 互換用
      const isBlocked2 = blockedSet.has(s.start + "__" + s.end) || blockedSet.has(s.startIso + "__" + s.endIso);

      div.className = "slot" + ((isBlocked || isBlocked2) ? " blocked":"");
      div.innerHTML = `<span class="mono">${(s.startLocal||"").slice(11,16)}-${(s.endLocal||"")}</span><span class="small">${(isBlocked||isBlocked2) ? "不可":"可"}</span>`;
      div.onclick = ()=>{
        toggleSlot(s);
        renderSlots(dayMap);
      };
      box.appendChild(div);
    });

    if(daySlots.length === 0){
      box.innerHTML = `<div class="small">枠がありません（条件や期間が0件の可能性）</div>`;
    }
  }

  function toggleSlot(s){
    const k = s.start + "__" + s.end;
    const i = blocks.findIndex(b => (b.startIso + "__" + b.endIso) === k);
    if(i >= 0) blocks.splice(i,1);
    else blocks.push({ startIso:s.start, endIso:s.end, reason:"" });
    dirty = true;
  }

  function blockWholeDay(dayMap){
    const daySlots = dayMap.get(selectedDayKey) || [];
    const existing = new Set(blocks.map(b=>blockKey(b)));
    daySlots.forEach(s=>{
      const k = s.start + "__" + s.end;
      if(!existing.has(k)) blocks.push({ startIso:s.start, endIso:s.end, reason:"" });
    });
    dirty = true;
    renderSlots(dayMap);
  }

  function clearWholeDay(dayMap){
    const daySlots = dayMap.get(selectedDayKey) || [];
    const daySet = new Set(daySlots.map(s=>s.start + "__" + s.end));
    blocks = blocks.filter(b => !daySet.has(blockKey(b)));
    dirty = true;
    renderSlots(dayMap);
  }

  async function loadAll(){
    el("msg").textContent = "";
    dirty = false;

    // token
    token = (qs("t") || "").trim();
    el("tokenView").textContent = token;
    if(!token) throw new Error("token がURLにありません。?t=XXXX を付けて開いてください。");

    // 1) slots
    const s = await post("getSlots", { token });
    slots = s.slots || [];

    // 2) blocks
    const b = await post("getBlocks", { token });
    blocks = b.blocks || [];

    // 表示
    const dayMap = buildDayMap();
    const keys = Array.from(dayMap.keys()).sort();
    el("rangeView").textContent = keys.length ? `${keys[0]} 〜 ${keys[keys.length-1]}` : "0件";

    renderDays(dayMap);
    renderSlots(dayMap);

    // ボタン
    el("blockDayBtn").onclick = ()=> blockWholeDay(dayMap);
    el("clearDayBtn").onclick = ()=> clearWholeDay(dayMap);
  }

  async function save(){
    if(!token) return;
    el("msg").textContent = "";
    const btn = el("saveBtn");
    btn.disabled = true;
    try{
      await post("setBlocks", { token, blocks });
      dirty = false;
      el("msg").style.color = "#065f46";
      el("msg").textContent = "保存しました。";
    }catch(e){
      el("msg").style.color = "#b91c1c";
      el("msg").textContent = "保存エラー: " + e.message;
    }finally{
      btn.disabled = false;
    }
  }

  el("reloadBtn").onclick = ()=> loadAll().catch(e=>{
    el("msg").style.color = "#b91c1c";
    el("msg").textContent = "読込エラー: " + e.message;
  });
  el("saveBtn").onclick = save;

  // 初期ロード
  loadAll().catch(e=>{
    el("msg").style.color = "#b91c1c";
    el("msg").textContent = "読込エラー: " + e.message;
  });
</script>
</body>
</html>
