<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>不可枠設定（社内）</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --text:#222; --muted:#666; --line:#e7e7ef; --accent:#2b6cff; --bad:#e5484d; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    h1{ font-size:18px; margin:0 0 6px; }
    .small{ font-size:12px; color:var(--muted); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{ appearance:none; border:0; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.secondary{ background:#111827; }
    .btn.danger{ background:var(--bad); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .grid{ display:grid; grid-template-columns: 260px 1fr; gap:12px; }
    .days{ display:flex; flex-direction:column; gap:8px; max-height:72vh; overflow:auto; padding-right:6px; }
    .dayItem{ border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff; cursor:pointer; }
    .dayItem.active{ outline:2px solid var(--accent); }
    .dayItem .d{ font-weight:700; }
    .slots{ display:flex; flex-wrap:wrap; gap:8px; }
    .slot{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; cursor:pointer; user-select:none; }
    .slot.blocked{ background:#ffe7e8; border-color:#ffb4b8; }
    .slot .t{ font-weight:700; font-size:13px; }
    .slot .s{ font-size:11px; color:var(--muted); }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .hint{ background:#0b1020; color:#e8f0ff; padding:10px 12px; border-radius:12px; overflow:auto; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>不可枠設定（社内）</h1>
    <div class="row">
      <div class="small">token: <span id="token" class="mono"></span></div>
      <div class="small">期間: <span id="range" class="mono"></span></div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button id="reloadBtn" class="btn secondary">再読み込み</button>
      <button id="saveBtn" class="btn">保存</button>
      <button id="clearDayBtn" class="btn danger" disabled>この日の不可枠を全解除</button>
      <button id="blockDayBtn" class="btn" disabled>この日を全て不可にする</button>
      <span id="msg" class="small"></span>
    </div>
    <div style="height:10px"></div>
    <div class="hint small">
      使い方：右の時間ボタンをクリックで「不可/可」を切り替え → 保存。<br/>
      「この日を全て不可」は、その日の全スロットをまとめて不可にします（あとでドラッグ対応します）。
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="grid">
    <div class="card">
      <div class="small">日付</div>
      <div id="days" class="days"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small">時間枠</div>
          <div id="dayTitle" style="font-weight:800; margin-top:4px;"></div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div id="slots" class="slots"></div>
    </div>
  </div>
</div>

<script>
/** ★ここだけ設定 */
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyJAPDsCu9QtgbZbg-4LrNqh_wY2GVROVecUT9ksO0RovJINC5As5ywcke_GJ50WmBL/exec";

/** CORS回避：text/plainでPOST */
async function post(action, payload){
  const res = await fetch(GAS_WEBAPP_URL, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify({action, ...payload})
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Non-JSON response: " + text.slice(0, 160)); }
  if(!data.ok) throw new Error(data.error || "Request failed");
  return data;
}

function qs(name){
  return new URLSearchParams(location.search).get(name);
}

function el(id){ return document.getElementById(id); }

let token = "";
let slots = [];     // {start,end,startLocal,endLocal}
let blocks = [];    // {startIso,endIso,...}
let selectedDayKey = ""; // "yyyy-MM-dd"
let dirty = false;

/** ISO -> dayKey in JST */
function dayKeyFromIso(iso){
  // startLocal が "yyyy-MM-dd HH:mm" なのでそれを使うのが一番安全
  // ただし万一無い場合のフォールバック
  const d = new Date(iso);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da= String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

function slotKey(s){ return `${s.start}__${s.end}`; }

function blockKey(b){ return `${b.startIso}__${b.endIso}`; }

function buildBlockedSet(){
  const set = new Set();
  blocks.forEach(b => set.add(blockKey(b)));
  return set;
}

function groupSlotsByDay(){
  const map = new Map(); // dayKey -> slot[]
  slots.forEach(s=>{
    const key = (s.startLocal && s.startLocal.slice(0,10)) ? s.startLocal.slice(0,10) : dayKeyFromIso(s.start);
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(s);
  });
  // sort each day
  for(const [k, arr] of map.entries()){
    arr.sort((a,b)=>a.start.localeCompare(b.start));
  }
  return map;
}

function renderDays(dayMap){
  const daysEl = el("days");
  daysEl.innerHTML = "";
  const keys = Array.from(dayMap.keys()).sort();
  keys.forEach(k=>{
    const div = document.createElement("div");
    div.className = "dayItem" + (k===selectedDayKey ? " active" : "");
    div.innerHTML = `<div class="d">${k}</div><div class="small">${dayMap.get(k).length} 枠</div>`;
    div.onclick = () => {
      if(dirty && !confirm("未保存の変更があります。日付を切り替えますか？")) return;
      dirty = false;
      selectedDayKey = k;
      renderAll();
    };
    daysEl.appendChild(div);
  });

  if(!selectedDayKey && keys.length) selectedDayKey = keys[0];
}

function toggleSlotBlocked(s){
  const k = slotKey(s);
  const i = blocks.findIndex(b => blockKey(b) === k);
  if(i >= 0){
    blocks.splice(i,1);
  }else{
    blocks.push({ startIso:s.start, endIso:s.end, reason:"" });
  }
  dirty = true;
  renderSlotsOnly();
}

function blockWholeDay(dayMap){
  const daySlots = dayMap.get(selectedDayKey) || [];
  // その日のスロットを全てblocksに入れる（既存重複は排除）
  const existing = new Set(blocks.map(b=>blockKey(b)));
  daySlots.forEach(s=>{
    const k = slotKey(s);
    if(!existing.has(k)) blocks.push({ startIso:s.start, endIso:s.end, reason:"" });
  });
  dirty = true;
  renderSlotsOnly();
}

function clearWholeDay(dayMap){
  const daySlots = dayMap.get(selectedDayKey) || [];
  const daySet = new Set(daySlots.map(s=>slotKey(s)));
  blocks = blocks.filter(b => !daySet.has(blockKey
